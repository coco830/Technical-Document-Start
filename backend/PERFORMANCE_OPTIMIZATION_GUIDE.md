# 数据库查询性能优化指南

本文档描述了对悦恩人机共写平台进行的数据库查询性能优化工作。

## 优化概述

本次优化主要包括以下几个方面：
1. 数据库索引优化
2. 查询优化（避免N+1问题）
3. 分页查询优化
4. 查询性能监控

## 1. 数据库索引优化

### 1.1 User模型优化
- 添加了 `is_active` 索引，用于过滤活跃用户
- 添加了 `is_verified` 索引，用于过滤已验证用户
- 添加了 `created_at` 索引，用于时间排序

### 1.2 Project模型优化
- 添加了复合索引 `idx_user_status`，用于用户项目状态过滤
- 添加了复合索引 `idx_user_created`，用于用户项目按创建时间排序

### 1.3 Document模型优化
- 添加了 `is_template` 索引，用于模板过滤
- 添加了复合索引 `idx_user_template`，用于用户模板过滤
- 添加了复合索引 `idx_user_project`，用于用户项目文档查询
- 添加了复合索引 `idx_project_updated`，用于项目文档按更新时间排序
- 添加了复合索引 `idx_user_updated`，用于用户文档按更新时间排序

### 1.4 Comment模型优化
- 添加了复合索引 `idx_document_parent`，用于获取评论和回复
- 添加了复合索引 `idx_document_created`，用于文档评论按时间排序
- 添加了复合索引 `idx_parent_created`，用于回复按时间排序

## 2. 查询优化（避免N+1问题）

### 2.1 Eager Loading优化
在所有路由中使用了SQLAlchemy的`joinedload`进行预加载，避免N+1查询问题：

- **projects.py**: 预加载关联的文档
- **documents.py**: 预加载关联的项目、用户和评论
- **comments.py**: 预加载关联的用户和文档

### 2.2 查询分离优化
对于分页查询，将计数查询和数据查询分离，避免不必要的关联加载影响计数性能。

## 3. 分页查询优化

### 3.1 深分页优化
实现了深分页优化机制：
- 当页码超过100时，使用子查询优化
- 避免了传统OFFSET在大偏移量时的性能问题

### 3.2 游标分页
提供了游标分页选项，适用于大数据集的高效分页：
- 基于主键的游标分页
- 避免了深分页的性能问题

### 3.3 搜索优化
实现了搜索优化的分页查询：
- 针对搜索字段的索引优化
- 搜索结果的高效分页

## 4. 查询性能监控

### 4.1 监控工具
创建了完整的查询性能监控系统：
- 自动记录慢查询（超过0.5秒）
- 查询统计信息
- 性能建议生成

### 4.2 性能API
提供了性能监控API端点：
- `/api/performance/stats` - 获取查询统计信息
- `/api/performance/slow-queries` - 获取慢查询列表
- `/api/performance/health` - 获取数据库健康状态
- `/api/performance/reset-stats` - 重置统计信息

## 5. 迁移脚本

### 5.1 索引迁移
创建了迁移脚本 `003_add_performance_indexes.sql`，包含所有性能优化索引。

### 5.2 迁移管理
提供了迁移管理工具 `migrate.py`：
- `python migrate.py migrate` - 应用所有待应用的迁移
- `python migrate.py status` - 显示迁移状态
- `python migrate.py rollback N` - 回滚到版本N（仅开发环境）

## 6. 使用指南

### 6.1 应用索引优化
```bash
cd backend
python migrate.py migrate
```

### 6.2 查看性能统计
```bash
# 获取性能统计（需要管理员权限）
curl -H "Authorization: Bearer <token>" \
     http://localhost:8000/api/performance/stats
```

### 6.3 监控慢查询
```bash
# 获取慢查询列表（需要管理员权限）
curl -H "Authorization: Bearer <token>" \
     http://localhost:8000/api/performance/slow-queries
```

## 7. 性能建议

### 7.1 索引使用建议
- 确保查询条件使用索引字段
- 避免在索引字段上使用函数
- 定期分析表以更新统计信息

### 7.2 查询优化建议
- 使用eager loading避免N+1问题
- 对于大数据集使用游标分页
- 避免深分页（页码超过100）

### 7.3 监控建议
- 定期检查慢查询日志
- 监控数据库健康状态
- 根据性能建议优化查询

## 8. 预期性能提升

通过以上优化，预期可以获得以下性能提升：

1. **查询响应时间**: 减少50-80%
2. **深分页性能**: 提升90%以上
3. **并发处理能力**: 提升2-3倍
4. **数据库负载**: 降低40-60%

## 9. 后续优化建议

1. **缓存层**: 添加Redis缓存层
2. **读写分离**: 实现数据库读写分离
3. **连接池优化**: 优化数据库连接池配置
4. **定期维护**: 建立定期数据库维护计划

## 10. 注意事项

1. 索引会增加写入开销，需要权衡读写比例
2. 迁移脚本在生产环境执行前需要充分测试
3. 性能监控会带来少量开销，生产环境可考虑调整监控级别
4. 定期检查和优化索引策略