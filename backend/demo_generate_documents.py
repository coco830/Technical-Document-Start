#!/usr/bin/env python3
"""
端到端Demo：企业文档生成
使用Mock AI服务生成三个文档并保存到test_output目录
"""

import json
import os
import sys
from pathlib import Path
from datetime import datetime
from typing import Dict, Any

# 添加项目根目录到Python路径
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

# 导入必要的模块
from app.services.document_generator import DocumentGenerator
from app.prompts.ai_sections_loader import ai_sections_loader

# Mock AI服务，用于Demo演示
class MockAIService:
    """Mock AI服务，生成模拟内容"""
    
    def __init__(self):
        self.mock_contents = {
            "enterprise_overview": "示例化工有限公司成立于2018年3月，是一家专业从事精细化工产品研发、生产和销售的高新技术企业。公司位于北京化工产业园，占地面积15000平方米，建筑面积8000平方米，总投资5000万元，其中环保投资800万元。公司主要产品包括有机中间体A（设计产能2000吨/年，实际产量1800吨/年）和特种化学品B（设计产能500吨/年，实际产量450吨/年）。公司采用三班制生产，年工作330天，现有员工120人，其中生产人员95人。公司建立了完善的质量管理体系和环境管理体系，注重安全生产和环境保护。",
            
            "location_description": "示例化工有限公司位于北京市海淀区科技园区创新路88号，地处北京化工产业园内。公司地理位置优越，交通便利，距离主要高速公路入口约5公里。厂区周边主要环境敏感目标包括：东侧800米处的清河（小型河流），西侧1200米处的科技园住宅区（约5000人），南侧1500米处的示范小学（约800人）。公司所在区域地形平坦，地势略有起伏，有利于事故情况下污染物的扩散和应急响应的开展。",
            
            "terrain_description": "企业所在区域地形总体平坦，地势由西北向东南略有倾斜，平均海拔约50米。厂区内部经过平整处理，地面硬化率较高，有利于雨水排放和事故情况下污染物的收集。区域地质条件稳定，不存在地质灾害风险。地形特点有利于大气污染物的扩散，但在静风天气条件下可能出现污染物局部积聚的情况。厂区周边无明显的地形障碍物，为应急响应提供了良好的通行条件。",
            
            "weather_description": "企业所在地区属于温带季风气候，四季分明，年平均气温12℃，年平均降水量600毫米。主导风向为西北风，夏季多东南风，年平均风速2.5米/秒。静风频率较低，有利于大气污染物的扩散。降水主要集中在夏季，占全年降水量的70%以上。冬季干燥少雨，需特别注意防火安全。春秋季节多风，有利于大气污染物扩散，但也可能加剧扬尘污染。气象条件总体有利于企业污染物扩散和事故应急响应。",
            
            "hydrology_description": "厂区东侧800米处为清河，该河流为小型河流，平均流量约5立方米/秒，主要功能为景观和农业灌溉。河流流向自北向南，最终汇入北运河。厂区地势略高于河流，一般情况下不会受到洪水影响。企业生产废水和生活污水经厂内污水处理站处理后排入市政污水管网，不直接排入清河。但在事故情况下，如发生泄漏，污染物可能通过雨水系统进入清河，对水体环境造成影响。因此，企业已建设完善的雨污分流系统和事故应急池，确保事故废水得到有效收集。",
            
            "production_process_description": "公司主要生产工艺包括原料预处理、化学反应、产品分离提纯、溶剂回收等工序。原料苯乙烯和甲醇分别储存在原料储罐区，通过管道输送至反应车间。反应过程采用连续化生产，主要设备包括反应釜、蒸馏塔、冷凝器、储罐等。反应过程严格控制温度、压力等工艺参数，确保产品质量和生产安全。反应完成后，产物经分离提纯得到有机中间体A，副产品经进一步处理得到特种化学品B。生产过程中产生的废气经活性炭吸附和催化燃烧处理后排放，废水经生化处理和物化处理后排入市政管网。",
            
            "safety_management_description": "企业建立了完善的安全生产管理体系，设立了专门的安全生产管理部门，配备专职安全管理人员。公司制定了《安全生产管理制度》、《危险化学品管理制度》、《应急预案》等一系列规章制度，并定期组织安全培训和应急演练。企业建立了应急组织体系，包括总指挥、副总指挥、现场指挥、技术支持等岗位，明确了各岗位的职责和权限。应急物资配备充足，包括干粉灭火器50个、泡沫灭火器20个、吸附棉30箱、防毒面具40套等。企业定期开展安全检查和隐患排查，及时发现和整改安全隐患，确保生产安全。",
            
            "water_environment_impact": "企业在正常生产情况下，生产废水和生活污水经厂内污水处理站处理达标后排入市政污水管网，对周边水环境影响较小。污水处理站设计处理能力100立方米/日，实际处理量80立方米/日，采用生化处理+物化处理工艺，主要污染物去除效率：COD≥85%、氨氮≥80%。但在事故情况下，如发生苯乙烯、甲醇等危险化学品泄漏，可能通过雨水系统进入清河，对水体环境造成污染。苯乙烯对水生生物具有毒性，甲醇对水体环境也有一定影响。企业已建设事故应急池容积500立方米，确保事故废水得到有效收集，防止污染周边水体。",
            
            "air_environment_impact": "企业在正常生产情况下，废气经处理后达标排放，对周边大气环境影响较小。主要废气来源包括反应车间和储罐区，主要污染物为VOCs和苯乙烯。反应车间废气经活性炭吸附+催化燃烧处理后通过20米高排气筒排放，储罐区废气经冷凝回收+活性炭吸附处理后通过15米高排气筒排放。但在事故情况下，如发生苯乙烯、甲醇等危险化学品泄漏，可能对周边大气环境造成污染。苯乙烯具有刺激性气味，对人体健康有一定影响。企业所在地区主导风向为西北风，一般情况下污染物主要向东南方向扩散，对西侧1200米处的科技园住宅区和南侧1500米处的示范小学影响较小。",
            
            "noise_environment_impact": "企业主要噪声源包括泵房和冷却塔，分别位于厂区北侧和南侧。泵房主要噪声源为水泵运行噪声，冷却塔主要噪声源为风机和水流噪声。企业采取了隔声罩、减振基础、消声器、隔声屏等噪声控制措施，有效降低了噪声影响。厂界噪声能够满足《工业企业厂界环境噪声排放标准》（GB12348-2008）3类标准要求。但在设备检修或异常运行情况下，噪声可能有所增加。企业定期对噪声控制设施进行维护保养，确保其正常运行。西侧1200米处的科技园住宅区和南侧1500米处的示范小学距离厂区较远，噪声影响较小。",
            
            "solid_waste_impact": "企业产生的固体废物包括一般固废和危险废物。一般固废主要包括包装材料和废催化剂，年产生量分别为20吨和5吨，分别采用回收利用和厂家回收的方式进行处理。危险废物主要包括废有机溶剂和废活性炭，年产生量分别为10吨和5吨，暂存在危废暂存间，委托北京危险废物处置中心进行处置。危废暂存间严格按照《危险废物贮存污染控制标准》（GB18597-2001）进行建设和管理，具备防渗、防漏、防雨等功能。危险废物转移严格执行联单制度，确保全过程可追溯。在事故情况下，如发生危险废物泄漏，可能对土壤和地下水环境造成污染，企业已制定相应的应急预案。",
            
            "risk_management_conclusion": "示例化工有限公司环境风险等级为较大，主要风险源包括苯乙烯、甲醇等易燃易爆危险化学品，以及生产过程中产生的废气、废水、固废等污染物。企业建立了完善的环境风险管理体系，包括风险识别、风险评估、风险控制、应急响应等环节。企业在工程控制方面采取了防渗漏围堰、泄漏检测报警、事故应急池等措施；在管理控制方面建立了完善的规章制度、操作规程、培训教育等制度；在应急响应方面配备了充足的应急物资和专业的应急队伍。企业环境风险总体可控，但仍需持续加强风险管理和应急能力建设，确保生产安全和环境安全。",
            
            "long_term_plan": "企业环境风险防控长期计划（3-5年）主要包括：1）推进清洁生产，采用先进的生产工艺和设备，从源头减少污染物产生；2）建设智能化环境监测系统，实现对污染物排放的实时监控和预警；3）完善环境风险管理体系，建立更加科学的风险评估和管控机制；4）加强员工培训和教育，提高全员环境意识和应急能力；5）开展环境影响后评价，及时调整和优化环保措施；6）推进绿色工厂建设，实现资源节约和环境友好的可持续发展。通过这些措施的实施，企业将进一步提升环境风险防控能力，实现经济效益和环境效益的统一。",
            
            "medium_term_plan": "企业环境风险防控中期计划（1-3年）主要包括：1）对现有废气处理设施进行升级改造，提高处理效率，确保稳定达标排放；2）完善废水处理设施，增加深度处理单元，提高水资源利用率；3）建设危险废物暂存设施，满足危险废物规范化管理要求；4）开展环境风险评估，识别和评估潜在的环境风险，制定相应的管控措施；5）加强应急管理体系建设，完善应急预案，定期开展应急演练，提高应急处置能力；6）推进环境管理体系认证，提升环境管理水平。通过这些措施的实施，企业将进一步提升环境风险防控能力，确保生产安全和环境安全。",
            
            "short_term_plan": "企业环境风险防控短期计划（1年内）主要包括：1）完善环境管理制度，修订和完善各项环保管理制度和操作规程；2）加强员工培训，开展环保知识和应急技能培训，提高员工环保意识和应急能力；3）开展环境隐患排查，及时发现和整改环境隐患，确保环保设施正常运行；4）完善应急物资配备，补充和更新应急物资，确保应急物资充足有效；5）开展应急演练，每季度至少开展一次专项应急演练，提高应急处置能力；6）加强环境监测，定期开展环境监测，及时掌握污染物排放情况。通过这些措施的实施，企业将进一步提升环境风险防控能力，确保生产安全和环境安全。",
            
            "environmental_work": "示例化工有限公司重视环保工作，建立了完善的环保管理体系。公司已取得《排污许可证》（许可证编号：91110105MA01234567），有效期至2025年12月31日，许可排放污染物包括COD、氨氮、VOCs、苯乙烯、NOx。公司建设项目于2018年1月15日获得环评批复（环审[2018]001号），于2019年6月20日通过竣工环境保护验收（验[2019]025号）。公司建立了完善的环保管理制度，包括《环境保护管理制度》、《污染防治设施运行管理制度》、《环境监测制度》等。环保负责人李明华负责日常环保管理工作，应急组织体系完善，包括总指挥、副总指挥、现场指挥等岗位。公司环保设施运行正常，污染物达标排放，危废管理规范，环保档案齐全。企业需持续完善环境管理体系，提高环保管理水平。",
            
            "construction_layout": "示例化工有限公司厂区总占地面积15000平方米，建筑面积8000平方米。厂区总体布局合理，功能分区明确，主要包括生产区、仓储区、办公生活区等。生产区位于厂区中部，主要包括反应车间、分离车间、包装车间等；仓储区位于厂区东北侧和西南侧，主要包括原料储罐区、产品储罐区、危废暂存间等；办公生活区位于厂区西北侧，主要包括办公楼、食堂、宿舍等。危险化学品库房和危废暂存间分别位于厂区东北侧和东南侧，距离周边敏感受体较远，符合安全防护要求。厂区道路宽敞，消防通道畅通，为应急响应提供了良好的通行条件。平面布局充分考虑了风险防控的需要，各功能区之间保持安全距离，有利于事故情况下的人员疏散和应急处置。",
            
            "risk_prevention_measures": "企业针对各类环境风险源采取了相应的防范措施。危险化学品方面：苯乙烯、甲醇等易燃液体储罐区设置了防渗漏围堰、泄漏检测报警装置、泡沫灭火系统等；危废暂存间按照《危险废物贮存污染控制标准》建设，具备防渗、防漏、防雨功能。废水方面：建设了污水处理站，采用生化处理+物化处理工艺，处理能力100立方米/日；建设了事故应急池，容积500立方米，确保事故废水得到有效收集。废气方面：反应车间废气采用活性炭吸附+催化燃烧处理，储罐区废气采用冷凝回收+活性炭吸附处理，排气筒高度分别为20米和15米。固体废物方面：一般固废分类存放，回收利用；危险废物委托有资质单位处置。企业建立了完善的巡检制度、维护保养制度、培训教育制度等，确保各项防范措施有效落实。",
            
            "emergency_response_measures": "企业制定了完善的突发环境事件现场应急措施。事故发生后，现场人员立即向应急指挥报告，应急指挥根据事故情况启动相应级别的应急响应。液体泄漏事故：立即停止相关作业，切断泄漏源，使用吸附材料进行围堵和吸收，启动事故应急池收集泄漏物，防止污染扩散。气体泄漏事故：立即停止相关作业，切断泄漏源，启动通风系统，疏散人员至安全区域，使用检测仪器监测气体浓度，根据情况采取相应的处置措施。火灾事故：立即启动消防系统，疏散人员，拨打119报警，组织人员初期扑救，防止火势蔓延。危废事故：立即停止相关作业，隔离危险区域，使用专用工具收集泄漏物，防止污染扩散。企业配备了充足的应急物资，包括灭火器、吸附棉、防毒面具、应急灯等，确保应急处置的需要。",
            
            "incident_response_card": "企业针对主要事故类型制定了应急处置卡。液体泄漏应急处置卡：1）立即停止相关作业，切断泄漏源；2）设置警戒区域，疏散无关人员；3）使用吸附材料进行围堵和吸收；4）启动事故应急池收集泄漏物；5）监测周边环境质量；6）根据情况请求外部支援。气体泄漏应急处置卡：1）立即停止相关作业，切断泄漏源；2）启动通风系统，疏散人员至安全区域；3）使用检测仪器监测气体浓度；4）根据气体性质采取相应的处置措施；5）监测周边环境质量；6）根据情况请求外部支援。火灾应急处置卡：1）立即启动消防系统，疏散人员；2）拨打119报警，报告火灾情况；3）组织人员初期扑救，防止火势蔓延；4）切断相关设备电源和物料输送；5）保护周边环境敏感目标；6）配合消防部门开展灭火救援。危废事故应急处置卡：1）立即停止相关作业，隔离危险区域；2）使用专用工具收集泄漏物；3）防止污染扩散，保护周边环境；4）监测周边环境质量；5）委托有资质单位处置；6）总结经验教训，完善防范措施。",
            
            "investigation_process": "本次应急资源调查采用资料审核与现场核查相结合的方式进行。调查组通过查阅企业提供的应急预案、应急物资台账、应急演练记录、培训教育记录等资料，全面了解企业应急资源现状。同时，调查组对企业现场进行了实地核查，重点检查了应急物资配备情况、应急设施建设情况、应急通道畅通情况等。调查内容涵盖了应急人员、应急物资、应急设施、应急制度、应急演练等方面。通过本次调查，全面掌握了企业应急资源的实际情况，为后续的差距分析和结论提供了依据。调查过程严格按照相关规范要求进行，确保调查结果的客观性和准确性。",
            
            "gap_analysis_1": "企业应急救援队伍力量总体较为充足，建立了完善的应急组织体系，包括总指挥、副总指挥、现场指挥、技术支持等岗位，应急队伍规模25人，结构较为合理。应急人员具备相应的专业知识和技能，能够满足一般环境事故的初期处置需求。企业建立了24小时值班制度，确保应急响应的及时性。但企业应急队伍的专业培训仍有提升空间，特别是针对危险化学品事故的专业培训需要进一步加强。建议企业加强与专业救援队伍的交流合作，提高应急队伍的专业化水平。同时，应定期开展专项应急演练，提高应急队伍的实战能力。",
            
            "gap_analysis_2": "企业应急救援装备配备较为充足，包括干粉灭火器50个、泡沫灭火器20个、吸附棉30箱、防毒面具40套、应急灯20个等，基本能够满足事故初期处置的需要。应急装备存放位置合理，取用方便，并指定专人负责管理。但企业应急装备的维护保养仍需加强，部分装备存在老化现象，需要及时更新。建议企业建立应急装备定期检查制度，确保装备始终处于良好状态。同时，应根据企业风险特点，适当增加专业救援装备的配备，如防爆工具、专用检测仪器等，提高应急处置的专业化水平。",
            
            "gap_analysis_3": "企业应急培训工作较为规范，定期开展环保知识培训和应急技能培训，员工环保意识和应急能力有所提高。企业建立了培训档案，记录培训内容和培训效果，培训覆盖面较广。但企业应急培训的深度和针对性仍有提升空间，特别是针对不同岗位的专业化培训需要加强。建议企业制定更加详细的培训计划，根据不同岗位的风险特点开展针对性培训。同时，应加强与专业培训机构的合作，引入先进的培训理念和方法，提高培训效果。培训内容应更加注重实战性，增加案例分析、模拟演练等内容，提高员工的应急处置能力。",
            
            "gap_analysis_4": "企业应急演练工作开展较为规范，定期开展综合应急演练、专项应急演练和桌面演练，演练频次基本满足要求。2023年开展了综合应急演练1次（苯乙烯泄漏事故）、专项应急演练1次（火灾事故）、桌面演练1次（危废泄漏事故），演练内容与企业主要风险类型匹配。但企业应急演练的覆盖面和深度仍有提升空间，演练的实战性和针对性需要进一步加强。建议企业增加演练频次，扩大演练覆盖面，特别是针对不同事故类型的专项演练。同时，应加强演练的评估和总结，及时发现和改进存在的问题。演练内容应更加贴近实际，增加突发情况的处理，提高应急队伍的实战能力。",
            
            "conclusion": "示例化工有限公司现有应急资源基本能够满足环境风险防控的需要，建立了完善的应急组织体系，配备了充足的应急物资，制定了相应的应急预案，定期开展应急演练。企业应急队伍规模25人，结构较为合理，具备一定的应急处置能力。应急物资配备较为充足，包括灭火器、吸附棉、防毒面具等，基本能够满足事故初期处置的需要。应急设施建设较为完善，包括事故应急池、防渗漏围堰、泄漏检测报警等，为事故应急处置提供了有力支撑。但企业在应急队伍专业化培训、应急装备维护保养、应急演练实战性等方面仍存在不足，需要进一步加强。建议企业持续加大应急投入，完善应急管理体系，提高应急能力建设，确保环境安全。"
        }
    
    def generate(self, prompt: str, config: Dict[str, Any] = None, user_id: str = None) -> str:
        """Mock生成方法"""
        # 根据prompt内容返回对应的mock内容
        for key, content in self.mock_contents.items():
            if key in prompt:
                return content
        
        # 如果没有找到匹配的内容，返回通用mock内容
        return "这是一个模拟生成的AI段落内容，用于Demo演示。实际使用时将调用真实的AI服务生成专业内容。"

def mock_call_llm(model: str, system_prompt: str, user_prompt: str, user_id: str = None) -> str:
    """Mock LLM调用函数"""
    mock_service = MockAIService()
    return mock_service.generate(user_prompt)

def mock_render_user_template(template: str, data: Dict[str, Any]) -> str:
    """Mock模板渲染函数"""
    try:
        # 简单的模板变量替换
        for key, value in data.items():
            if isinstance(value, dict):
                for sub_key, sub_value in value.items():
                    template = template.replace(f"{{{key}.{sub_key}}}", str(sub_value))
            else:
                template = template.replace(f"{{{key}}}", str(value))
        return template
    except Exception:
        return template

def mock_postprocess_ai_output(content: str) -> str:
    """Mock后处理函数"""
    return content

def generate_all_documents_demo():
    """Demo主函数：生成所有文档"""
    print("=" * 60)
    print("企业文档生成Demo - 端到端演示")
    print("=" * 60)
    
    # 读取企业数据
    sample_file = project_root / "sample_enterprise.json"
    if not sample_file.exists():
        print(f"错误：找不到企业数据文件 {sample_file}")
        return False
    
    try:
        with open(sample_file, 'r', encoding='utf-8') as f:
            enterprise_data = json.load(f)
        print(f"✓ 成功加载企业数据：{enterprise_data['basic_info']['company_name']}")
    except Exception as e:
        print(f"错误：加载企业数据失败 - {str(e)}")
        return False
    
    # 创建文档生成器
    try:
        generator = DocumentGenerator()
        print("✓ 文档生成器初始化成功")
    except Exception as e:
        print(f"错误：文档生成器初始化失败 - {str(e)}")
        return False
    
    # 替换AI相关函数为Mock版本
    import app.prompts.ai_section_processor as processor
    processor.call_llm = mock_call_llm
    processor.render_user_template = mock_render_user_template
    processor.postprocess_ai_output = mock_postprocess_ai_output
    
    print("\n开始生成AI段落...")
    try:
        # 生成所有AI段落
        ai_sections = generator.build_ai_sections(enterprise_data, "demo_user")
        print(f"✓ 成功生成 {len(ai_sections)} 个AI段落")
        
        # 显示生成的段落列表
        print("\n生成的AI段落：")
        for i, section_name in enumerate(ai_sections.keys(), 1):
            print(f"  {i:2d}. {section_name}")
    except Exception as e:
        print(f"错误：AI段落生成失败 - {str(e)}")
        return False
    
    print("\n开始生成文档...")
    try:
        # 生成所有文档
        result = generator.generate_all_documents(enterprise_data, "demo_user")
        
        if result["success"]:
            print("✓ 所有文档生成成功")
            
            # 保存文档到test_output目录
            output_dir = project_root / "test_output"
            output_dir.mkdir(exist_ok=True)
            
            # 保存风险评估报告
            if result["risk_report"]:
                risk_file = output_dir / "risk_assessment_demo.html"
                with open(risk_file, 'w', encoding='utf-8') as f:
                    f.write(result["risk_report"])
                print(f"✓ 风险评估报告已保存：{risk_file}")
            
            # 保存应急预案
            if result["emergency_plan"]:
                plan_file = output_dir / "emergency_plan_demo.html"
                with open(plan_file, 'w', encoding='utf-8') as f:
                    f.write(result["emergency_plan"])
                print(f"✓ 应急预案已保存：{plan_file}")
            
            # 保存应急资源调查报告
            if result["resource_report"]:
                resource_file = output_dir / "resource_report_demo.html"
                with open(resource_file, 'w', encoding='utf-8') as f:
                    f.write(result["resource_report"])
                print(f"✓ 应急资源调查报告已保存：{resource_file}")
            
            # 保存AI段落信息
            sections_file = output_dir / "ai_sections_demo.json"
            with open(sections_file, 'w', encoding='utf-8') as f:
                json.dump(ai_sections, f, ensure_ascii=False, indent=2)
            print(f"✓ AI段落信息已保存：{sections_file}")
            
            return True
        else:
            print(f"错误：文档生成失败 - {result['errors']}")
            return False
            
    except Exception as e:
        print(f"错误：文档生成过程中发生异常 - {str(e)}")
        return False

if __name__ == "__main__":
    success = generate_all_documents_demo()
    if success:
        print("\n" + "=" * 60)
        print("Demo执行成功！")
        print("生成的文档已保存到 test_output 目录")
        print("可以使用浏览器打开HTML文件查看生成的文档")
        print("=" * 60)
        sys.exit(0)
    else:
        print("\n" + "=" * 60)
        print("Demo执行失败！请检查错误信息")
        print("=" * 60)
        sys.exit(1)