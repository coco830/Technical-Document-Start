# 前端路由系统指南

## 概述

本文档描述了悦恩人机共写平台的前端路由系统架构、组件和最佳实践。

## 路由架构

### 核心组件

1. **App.tsx** - 主路由配置文件
2. **AuthProvider.tsx** - 认证状态管理
3. **ProtectedRoute.tsx** - 受保护路由组件
4. **RouteGuard.tsx** - 路由守卫组件
5. **Layout.tsx** - 统一布局组件

### 路由结构

```
/ (首页) - 公开路由
/login (登录) - 公开路由，已认证用户会被重定向到仪表盘
/register (注册) - 公开路由，已认证用户会被重定向到仪表盘
/dashboard (仪表盘) - 受保护路由
/projects (项目管理) - 受保护路由
/templates (模板库) - 受保护路由
/editor/:id? (编辑器) - 受保护路由
/unauthorized (无权限) - 受保护路由，当用户无权限访问时显示
/* (404) - 捕获所有未匹配的路由
```

## 认证流程

### 1. 初始化认证状态

当应用启动时，`AuthProvider` 会：
- 从本地存储中读取token
- 初始化认证状态
- 如果有token但没有用户信息，尝试获取用户信息

### 2. 路由守卫

`RouteGuard` 组件提供以下功能：
- 检查用户认证状态
- 处理未认证用户的重定向
- 处理已认证用户访问登录/注册页的重定向
- 支持基于角色的访问控制

### 3. 受保护路由

`ProtectedRoute` 组件提供：
- 加载状态显示
- 认证失败时的重定向
- 防止未认证用户访问受保护内容

## 页面组件

### 1. Layout组件

`Layout` 组件为所有受保护页面提供统一的布局：
- 顶部导航栏
- 侧边栏导航（编辑器页面除外）
- 用户信息和退出登录功能
- 页面标题和操作按钮

### 2. 错误页面

- **NotFound.tsx** - 404页面，显示友好的错误信息
- **Unauthorized.tsx** - 403页面，显示无权限访问信息

## 最佳实践

### 1. 路由保护

所有需要认证的路由都应该使用双重保护：
```tsx
<Route path="/dashboard" element={
  <RouteGuard requireAuth={true}>
    <ProtectedRoute>
      <Dashboard />
    </ProtectedRoute>
  </RouteGuard>
}>
```

### 2. 页面导航

使用 `Layout` 组件的 `showBackButton` 属性提供返回按钮：
```tsx
<Layout title="页面标题" showBackButton={true}>
  {/* 页面内容 */}
</Layout>
```

### 3. 错误处理

- 使用 `RouteGuard` 处理认证错误
- 使用 `Layout` 组件显示页面特定的错误信息
- 使用全局错误处理捕获API错误

### 4. 加载状态

- 在 `ProtectedRoute` 中显示加载状态
- 在 `RouteGuard` 中显示认证验证状态
- 在页面组件中显示数据加载状态

## 测试指南

### 1. 认证流程测试

1. 访问受保护路由，验证重定向到登录页
2. 登录后，验证重定向到仪表盘
3. 登录后访问登录/注册页，验证重定向到仪表盘
4. 登出后，验证访问受保护路由会重定向到登录页

### 2. 路由导航测试

1. 测试所有路由是否正确加载
2. 测试浏览器前进/后退按钮
3. 测试直接URL访问
4. 测试刷新页面

### 3. 错误页面测试

1. 访问不存在的路由，验证显示404页面
2. 触发无权限错误，验证显示403页面
3. 测试错误页面的返回按钮

## 故障排除

### 常见问题

1. **路由不匹配**
   - 检查路由配置是否正确
   - 确认路由路径是否与实际路径匹配

2. **认证状态不正确**
   - 检查 `AuthProvider` 是否正确初始化
   - 确认token是否正确存储和读取

3. **重定向循环**
   - 检查 `RouteGuard` 的重定向逻辑
   - 确认认证状态检查是否正确

4. **布局不显示**
   - 检查 `Layout` 组件是否正确导入
   - 确认页面组件是否正确使用 `Layout`

## 未来改进

1. **代码分割** - 实现路由级别的代码分割，提高加载性能
2. **路由预加载** - 预加载可能访问的路由组件
3. **更细粒度的权限控制** - 实现基于功能的权限控制
4. **路由动画** - 添加页面切换动画