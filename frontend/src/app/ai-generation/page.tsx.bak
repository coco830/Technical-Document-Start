'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { AIGenerationHistory } from '@/components/ai-generation/AIGenerationHistory'
import { AIGenerationResult } from '@/components/ai-generation/AIGenerationResult'
import { RouteGuard } from '@/components/auth/route-guard'
import { aiGenerationApi } from '@/lib/api'
import { AIGenerationWithDetails, AIGenerationStatus } from '@/types'

function AIGenerationPageContent() {
  const router = useRouter()
  const [selectedGeneration, setSelectedGeneration] = useState<AIGenerationWithDetails | null>(null)
  const [recentGenerations, setRecentGenerations] = useState<AIGenerationWithDetails[]>([])
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    fetchRecentGenerations()
  }, [])

  const fetchRecentGenerations = async () => {
    setIsLoading(true)
    setError(null)

    try {
      const response = await aiGenerationApi.getAIGenerations({
        limit: 5,
        order_by: 'created_at',
        order_desc: true,
      })
      
      if (response.success && response.data) {
        setRecentGenerations(response.data.generations)
      } else {
        setError(response.error || 'è·å–æœ€è¿‘ç”Ÿæˆè®°å½•å¤±è´¥')
      }
    } catch (err) {
      setError('è·å–æœ€è¿‘ç”Ÿæˆè®°å½•å¤±è´¥')
      console.error('Failed to fetch recent generations:', err)
    } finally {
      setIsLoading(false)
    }
  }

  const handleCreateNew = () => {
    router.push('/ai-generation/new')
  }

  const handleCreateEmergencyPlan = () => {
    router.push('/ai-generation/new?type=emergency_plan')
  }

  const handleCreateEnvironmentalAssessment = () => {
    router.push('/ai-generation/new?type=environmental_assessment')
  }

  const handleGenerationSelect = (generation: AIGenerationWithDetails) => {
    setSelectedGeneration(generation)
  }

  const handleCopy = async (content: string) => {
    try {
      await navigator.clipboard.writeText(content)
      // è¿™é‡Œå¯ä»¥æ·»åŠ æˆåŠŸæç¤º
    } catch (err) {
      console.error('Failed to copy content:', err)
      // è¿™é‡Œå¯ä»¥æ·»åŠ å¤±è´¥æç¤º
    }
  }

  const handleDownload = (content: string, filename: string) => {
    const blob = new Blob([content], { type: 'text/plain' })
    const url = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = filename
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    window.URL.revokeObjectURL(url)
  }

  const handleRegenerate = (id: number) => {
    router.push(`/ai-generation/new?regenerate=${id}`)
  }

  const handleBackToList = () => {
    setSelectedGeneration(null)
    fetchRecentGenerations() // åˆ·æ–°åˆ—è¡¨
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div className="px-4 py-6 sm:px-0">
          {/* é¡µé¢æ ‡é¢˜ */}
          <div className="mb-8">
            <h1 className="text-3xl font-bold text-gray-900">
              AIå†…å®¹ç”Ÿæˆ
            </h1>
            <p className="mt-2 text-gray-600">
              ä½¿ç”¨AIæŠ€æœ¯ç”Ÿæˆä¸“ä¸šå†…å®¹ï¼Œæ”¯æŒå¤šç§ç”Ÿæˆæ¨¡å¼å’Œé…ç½®é€‰é¡¹
            </p>
          </div>

          {/* ç”Ÿæˆé€‰é¡¹ */}
          <div className="mb-8">
            <Card>
              <CardHeader>
                <CardTitle>é€‰æ‹©ç”Ÿæˆç±»å‹</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div className="text-center p-6 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                    <div className="text-4xl mb-4">ğŸ“</div>
                    <h3 className="text-lg font-semibold mb-2">é€šç”¨å†…å®¹ç”Ÿæˆ</h3>
                    <p className="text-gray-600 mb-4">
                      æ ¹æ®è‡ªå®šä¹‰æç¤ºè¯ç”Ÿæˆå„ç±»ä¸“ä¸šå†…å®¹
                    </p>
                    <Button onClick={handleCreateNew}>
                      å¼€å§‹ç”Ÿæˆ
                    </Button>
                  </div>
                  
                  <div className="text-center p-6 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                    <div className="text-4xl mb-4">ğŸš¨</div>
                    <h3 className="text-lg font-semibold mb-2">åº”æ€¥é¢„æ¡ˆç”Ÿæˆ</h3>
                    <p className="text-gray-600 mb-4">
                      åŸºäºä¼ä¸šä¿¡æ¯ç”Ÿæˆä¸“ä¸šçš„åº”æ€¥é¢„æ¡ˆæ–‡æ¡£
                    </p>
                    <Button onClick={handleCreateEmergencyPlan}>
                      ç”Ÿæˆé¢„æ¡ˆ
                    </Button>
                  </div>
                  
                  <div className="text-center p-6 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                    <div className="text-4xl mb-4">ğŸŒ</div>
                    <h3 className="text-lg font-semibold mb-2">ç¯è¯„æŠ¥å‘Šç”Ÿæˆ</h3>
                    <p className="text-gray-600 mb-4">
                      æ ¹æ®é¡¹ç›®ä¿¡æ¯ç”Ÿæˆç¯å¢ƒå½±å“è¯„ä»·æŠ¥å‘Š
                    </p>
                    <Button onClick={handleCreateEnvironmentalAssessment}>
                      ç”ŸæˆæŠ¥å‘Š
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>

          {/* é”™è¯¯æç¤º */}
          {error && (
            <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-md">
              <div className="text-red-800">{error}</div>
            </div>
          )}

          {/* é€‰ä¸­ç”Ÿæˆè¯¦æƒ… */}
          {selectedGeneration && (
            <div className="mb-8">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-semibold">ç”Ÿæˆè¯¦æƒ…</h2>
                <Button variant="outline" onClick={handleBackToList}>
                  è¿”å›åˆ—è¡¨
                </Button>
              </div>
              <AIGenerationResult
                generation={selectedGeneration}
                onCopy={handleCopy}
                onDownload={handleDownload}
                onRegenerate={handleRegenerate}
              />
            </div>
          )}

          {/* æœ€è¿‘ç”Ÿæˆè®°å½• */}
          {!selectedGeneration && (
            <div>
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-semibold">æœ€è¿‘ç”Ÿæˆè®°å½•</h2>
                <Button variant="outline" onClick={() => router.push('/ai-generation/history')}>
                  æŸ¥çœ‹å…¨éƒ¨
                </Button>
              </div>
              
              {isLoading ? (
                <div className="flex justify-center items-center py-12">
                  <div className="text-lg text-gray-600">åŠ è½½ä¸­...</div>
                </div>
              ) : recentGenerations.length === 0 ? (
                <div className="text-center py-12">
                  <div className="text-lg text-gray-600 mb-4">
                    æ‚¨è¿˜æ²¡æœ‰ä»»ä½•ç”Ÿæˆè®°å½•
                  </div>
                  <Button onClick={handleCreateNew}>
                    åˆ›å»ºç¬¬ä¸€ä¸ªç”Ÿæˆä»»åŠ¡
                  </Button>
                </div>
              ) : (
                <div className="space-y-4">
                  {recentGenerations.map((generation) => (
                    <AIGenerationResult
                      key={generation.id}
                      generation={generation}
                      onCopy={handleCopy}
                      onDownload={handleDownload}
                      onRegenerate={handleRegenerate}
                      showActions={false}
                    />
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

export default function AIGenerationPage() {
  return (
    <RouteGuard requireAuth={true}>
      <AIGenerationPageContent />
    </RouteGuard>
  )
}